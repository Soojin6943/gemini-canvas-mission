<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우아한테크코스 데일리 AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        
        :root {
            --theme-color: #0CEFD3;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(12, 239, 211, 0.3); border-radius: 10px; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; }
        .dark input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.1; }
        
        input[type="number"]::-webkit-inner-spin-button { display: none; }

        .step-transition {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Tooltip style */
        .custom-tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .group:hover .custom-tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        theme: '#0CEFD3',
                    }
                }
            }
        }
    </script>
</head>
<body class="dark bg-slate-950 text-slate-900 dark:text-white selection:bg-cyan-500/30">

    <div id="app" class="min-h-screen p-4 md:p-8 flex flex-col items-center">
        <div class="max-w-xl w-full flex flex-col items-center gap-6">
            
            <!-- Header -->
            <div class="w-full flex justify-between items-center py-6 px-4">
                <div class="flex flex-col">
                    <h1 class="text-4xl font-black tracking-tighter flex items-center text-slate-900 dark:text-white">
                        우아한테크코스
                        <span class="inline-block w-3 h-3 ml-2 rounded-full shadow-[0_0_10px_#0CEFD3] bg-theme"></span>
                    </h1>
                    <p class="text-[10px] font-black tracking-[0.5em] uppercase text-slate-400 dark:text-white/20">Daily Meeting Assistant</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="toggleDarkMode()" class="w-12 h-12 rounded-full flex items-center justify-center transition-all active:scale-90 border bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-400 dark:text-amber-300 shadow-sm">
                        <i data-lucide="sun" id="sun-icon"></i>
                        <i data-lucide="moon" id="moon-icon" class="hidden"></i>
                    </button>
                    <button onclick="openCalendar()" class="w-12 h-12 rounded-full flex items-center justify-center transition-all active:scale-90 border bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-400 dark:text-white shadow-sm">
                        <i data-lucide="calendar"></i>
                    </button>
                </div>
            </div>

            <!-- Main Card -->
            <div id="main-card" class="w-full rounded-[4rem] shadow-2xl overflow-hidden p-8 md:p-12 relative border transition-all duration-500 bg-white dark:bg-slate-900 border-slate-200 dark:border-white/5">
                
                <!-- Section 0: Setup -->
                <div id="section-setup" class="space-y-12 animate-in fade-in slide-in-from-top-6">
                    <div class="text-center space-y-4">
                        <div class="w-24 h-24 rounded-full flex items-center justify-center mx-auto border border-slate-100 dark:border-white/5 bg-theme/10 shadow-inner">
                            <i data-lucide="sparkles" class="w-12 h-12 text-theme"></i>
                        </div>
                        <h2 class="text-3xl font-black text-slate-800 dark:text-white text-center">데일리 미팅 설정</h2>
                        <p class="text-sm font-bold opacity-30 tracking-widest uppercase text-slate-500 dark:text-white/40">Participants & Duration</p>
                    </div>
                    <div class="grid gap-5">
                        <div class="flex items-center justify-between p-6 rounded-[3rem] border shadow-inner bg-slate-50 dark:bg-slate-950/50 border-slate-100 dark:border-white/5 text-slate-800 dark:text-white">
                            <button onclick="adjustCrew(-1)" class="w-14 h-14 rounded-2xl border flex items-center justify-center text-3xl font-black bg-white dark:bg-slate-800 border-slate-200 dark:border-white/5 text-slate-400 dark:text-white/20 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors shadow-md">-</button>
                            <div class="flex flex-col items-center">
                                <input type="number" id="input-crew" value="5" class="w-28 text-center text-6xl font-black bg-transparent focus:outline-none text-theme" />
                                <span class="text-[11px] font-black tracking-[0.4em] mt-1 opacity-40 uppercase text-slate-400 dark:text-white/40">Crews</span>
                            </div>
                            <button onclick="adjustCrew(1)" class="w-14 h-14 rounded-2xl border flex items-center justify-center text-3xl font-black bg-white dark:bg-slate-800 border-slate-200 dark:border-white/5 text-slate-400 dark:text-white/20 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors shadow-md">+</button>
                        </div>
                        <div class="flex items-center justify-between p-6 rounded-[3rem] border shadow-inner bg-slate-50 dark:bg-slate-950/50 border-slate-100 dark:border-white/5 text-slate-800 dark:text-white">
                            <button onclick="adjustDuration(-5)" class="w-14 h-14 rounded-2xl border flex items-center justify-center text-3xl font-black bg-white dark:bg-slate-800 border-slate-200 dark:border-white/5 text-slate-400 dark:text-white/20 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors shadow-md">-</button>
                            <div class="flex flex-col items-center">
                                <div class="flex items-baseline gap-1">
                                    <input type="number" id="input-duration" value="20" max="30" class="w-28 text-center text-6xl font-black bg-transparent focus:outline-none text-theme" />
                                    <span class="text-2xl font-black text-theme">m</span>
                                </div>
                                <span class="text-[11px] font-black tracking-[0.4em] mt-1 opacity-40 uppercase text-slate-400 dark:text-white/40">Duration</span>
                            </div>
                            <button onclick="adjustDuration(5)" class="w-14 h-14 rounded-2xl border flex items-center justify-center text-3xl font-black bg-white dark:bg-slate-800 border-slate-200 dark:border-white/5 text-slate-400 dark:text-white/20 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors shadow-md">+</button>
                        </div>
                        <div class="p-6 rounded-[3rem] border flex items-center gap-6 bg-slate-50 dark:bg-slate-950/50 border-slate-100 dark:border-white/5">
                            <i data-lucide="calendar" class="w-8 h-8 opacity-20 text-slate-400 dark:text-white"></i>
                            <input type="date" id="input-date" class="bg-transparent text-xl font-black focus:outline-none flex-1 text-slate-700 dark:text-white" />
                        </div>
                    </div>
                    <button onclick="startJourney()" class="w-full py-7 rounded-[2.5rem] font-black text-3xl shadow-[0_20px_40px_rgba(12,239,211,0.25)] hover:brightness-110 transition-all flex items-center justify-center gap-4 active:scale-95 bg-theme text-slate-900">
                        주제 선택 시작 <i data-lucide="arrow-right" class="w-8 h-8" stroke-width="4"></i>
                    </button>
                </div>

                <!-- Section 1-3: Selection -->
                <div id="section-selection" class="hidden space-y-10 py-2 animate-in fade-in">
                    <div id="stepper-container"></div>
                    <div class="text-center space-y-2">
                        <h3 class="text-2xl font-black text-slate-800 dark:text-white">미팅의 방향을 선택해주세요</h3>
                        <p class="text-sm font-bold opacity-30 tracking-tight text-slate-500 dark:text-white/40">AI가 산뜻하고 가벼운 주제를 제안합니다</p>
                    </div>
                    <div id="options-grid" class="grid gap-4"></div>
                    <button onclick="handleBack()" id="btn-back" class="w-full py-5 rounded-[2rem] font-black transition-all flex items-center justify-center gap-3 text-sm border mt-4 bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/5 text-slate-400 dark:text-white/30 hover:bg-slate-100 dark:hover:bg-white/10">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i> 이전 단계로
                    </button>
                </div>

                <!-- Section 4: Loading -->
                <div id="section-loading" class="hidden flex flex-col items-center py-40 space-y-12 animate-in fade-in">
                    <div class="relative">
                        <div class="w-28 h-28 border-8 rounded-full animate-spin border-slate-100 dark:border-white/5 border-t-theme"></div>
                        <i data-lucide="sparkles" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 text-cyan-400 animate-pulse shadow-[0_0_20px_#0CEFD3]"></i>
                    </div>
                    <div class="text-center space-y-3 px-10">
                        <p class="font-black text-3xl text-slate-800 dark:text-white">최적의 플랜을 구성 중입니다</p>
                        <p id="loading-path" class="text-sm font-bold opacity-30 leading-relaxed uppercase tracking-tighter text-slate-500 dark:text-white/40"></p>
                    </div>
                </div>

                <!-- Section 5: Final Result -->
                <div id="section-result" class="hidden space-y-10 animate-in fade-in zoom-in py-4">
                    <div class="bg-theme text-slate-900 p-12 rounded-[4.5rem] text-center space-y-5 shadow-2xl relative overflow-hidden">
                        <div class="flex justify-center gap-3 mb-2">
                            <span id="res-date" class="bg-black/10 px-5 py-2 rounded-full text-[11px] font-black uppercase tracking-widest"></span>
                            <span id="res-crew" class="bg-black/10 px-5 py-2 rounded-full text-[11px] font-black uppercase tracking-widest"></span>
                        </div>
                        <h2 id="res-title" class="text-5xl font-black leading-tight tracking-tighter drop-shadow-md"></h2>
                        <p id="res-catchphrase" class="text-slate-900/60 text-lg font-bold italic leading-tight px-4"></p>
                    </div>
                    
                    <div class="space-y-10">
                        <div id="save-status-container"></div>
                        <div class="grid grid-cols-2 gap-6 px-2">
                            <div class="relative group p-8 border rounded-[3rem] shadow-inner bg-slate-50 dark:bg-slate-950/50 border-slate-100 dark:border-white/5 cursor-help">
                                <h5 class="text-[11px] font-black opacity-30 uppercase mb-4 tracking-widest flex items-center gap-2 text-slate-500 dark:text-white/40">
                                    <i data-lucide="clipboard" class="w-4 h-4"></i> 준비물
                                </h5>
                                <p id="res-materials" class="text-base font-black truncate leading-none text-slate-800 dark:text-white"></p>
                                <div id="res-materials-tooltip" class="custom-tooltip absolute z-30 bottom-full left-1/2 -translate-x-1/2 mb-4 w-64 p-4 bg-slate-800 dark:bg-slate-700 text-white text-xs font-bold rounded-2xl shadow-2xl text-center leading-relaxed"></div>
                            </div>
                            <div class="relative group p-8 border rounded-[3rem] shadow-inner bg-slate-50 dark:bg-slate-950/50 border-slate-100 dark:border-white/5 cursor-help">
                                <h5 class="text-[11px] font-black opacity-30 uppercase mb-4 tracking-widest flex items-center gap-2 text-slate-500 dark:text-white/40">
                                    <i data-lucide="target" class="w-4 h-4"></i> 핵심 효과
                                </h5>
                                <p id="res-benefit" class="text-base font-black truncate uppercase leading-none text-theme"></p>
                                <div id="res-benefit-tooltip" class="custom-tooltip absolute z-30 bottom-full left-1/2 -translate-x-1/2 mb-4 w-64 p-4 bg-slate-800 dark:bg-slate-700 text-white text-xs font-bold rounded-2xl shadow-2xl text-center leading-relaxed"></div>
                            </div>
                        </div>
                        <div class="space-y-6 px-2">
                            <h5 class="text-[11px] font-black opacity-30 uppercase px-6 tracking-widest text-slate-400 dark:text-white/30">Execution Guide</h5>
                            <div id="steps-container" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button onclick="handleBack()" class="py-6 rounded-[2.5rem] font-black transition-all flex items-center justify-center gap-3 text-lg border bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/5 text-slate-500 dark:text-white/30 shadow-sm">이전 단계</button>
                        <button onclick="resetApp()" class="py-6 rounded-[2.5rem] font-black transition-all flex items-center justify-center gap-3 text-lg border bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/5 text-slate-500 dark:text-white/30 shadow-sm">처음으로</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-center gap-2 mb-10 opacity-20 dark:opacity-40">
                <p class="text-slate-900 dark:text-white text-[10px] font-black tracking-[0.5em] uppercase text-center">Official Daily Tool for Woowa Course</p>
                <div class="w-20 h-1 rounded-full bg-slate-900 dark:bg-white"></div>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendar-modal" class="fixed inset-0 z-50 p-12 flex flex-col hidden step-transition bg-white dark:bg-slate-900 shadow-2xl">
        <div class="max-w-xl w-full mx-auto flex flex-col h-full">
            <div class="flex justify-between items-center mb-16 text-slate-800 dark:text-white">
                <div class="flex items-center gap-6">
                    <i data-lucide="calendar" class="w-10 h-10 text-theme"></i>
                    <h2 class="text-4xl font-black">데일리 기록부</h2>
                </div>
                <button onclick="closeCalendar()" class="w-16 h-16 rounded-full flex items-center justify-center border shadow-md active:scale-90 bg-slate-50 dark:bg-white/5 border-slate-100 dark:border-white/10">
                    <i data-lucide="x" class="w-10 h-10 opacity-30"></i>
                </button>
            </div>
            <div id="calendar-content" class="flex-1 overflow-y-auto pr-2 custom-scrollbar text-slate-800 dark:text-white"></div>
        </div>
    </div>

    <!-- Firebase & App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Environment constants
        const apiKey = "";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'daily-meeting-ai';
        const firebaseConfig = JSON.parse(__firebase_config);
        const THEME_COLOR = "#0CEFD3";
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let state = {
            user: null,
            step: 0,
            crewCount: 5,
            duration: 20,
            date: new Date().toISOString().split('T')[0],
            choices: [],
            options: [],
            finalResult: null,
            isSaved: false,
            history: [],
            isDarkMode: true,
            focusedStepIndex: 0,
            calendarMonth: new Date(),
            showCalendar: false
        };

        const FIRST_STEP_OPTIONS = [
            { keyword: "수다", example: "TMI, 인생 맛집, 주말 계획 등 사소한 이야기", icon: "message-circle" },
            { keyword: "활동", example: "종이비행기, 산책, 명상 등 몸으로 하는 미션", icon: "zap" },
            { keyword: "논의", example: "기술 퀴즈 대결, 밸런스 게임, 가치관 논쟁", icon: "brain" },
            { keyword: "게임", example: "라이어 게임, 캐치마인드 등 순수 재미 위주", icon: "gamepad-2" },
        ];

        // --- Core Logic ---

        window.toggleDarkMode = () => {
            state.isDarkMode = !state.isDarkMode;
            document.body.classList.toggle('dark', state.isDarkMode);
            document.getElementById('sun-icon').classList.toggle('hidden', !state.isDarkMode);
            document.getElementById('moon-icon').classList.toggle('hidden', state.isDarkMode);
        };

        window.adjustCrew = (val) => {
            state.crewCount = Math.max(2, state.crewCount + val);
            document.getElementById('input-crew').value = state.crewCount;
        };

        window.adjustDuration = (val) => {
            state.duration = Math.min(30, Math.max(5, state.duration + val));
            document.getElementById('input-duration').value = state.duration;
        };

        const showSection = (id) => {
            const sections = ['section-setup', 'section-selection', 'section-loading', 'section-result'];
            sections.forEach(s => {
                const el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
        };

        window.startJourney = () => {
            state.step = 1;
            state.choices = [];
            state.isSaved = false;
            state.finalResult = null;
            state.date = document.getElementById('input-date').value;
            renderSelectionPhase();
        };

        const renderStepper = () => {
            const container = document.getElementById('stepper-container');
            container.innerHTML = `
                <div class="w-full px-6 py-8 mb-4">
                    <div class="flex items-start justify-between relative">
                        <div class="absolute top-7 left-0 right-0 h-1.5 bg-slate-100 dark:bg-white/5 transition-colors">
                            <div class="h-full bg-theme transition-all duration-500 shadow-[0_0_10px_#0CEFD3]" style="width: ${((state.step - 1) / 2) * 100}%"></div>
                        </div>
                        ${[1, 2, 3].map(i => {
                            const isCompleted = i < state.step;
                            const isCurrent = i === state.step;
                            const choice = state.choices[i-1];
                            const canJump = i < state.step;
                            return `
                                <div class="flex flex-col items-center gap-4 relative z-10 w-1/3">
                                    <button 
                                        ${canJump ? `onclick="window.goToStep(${i})"` : 'disabled'}
                                        class="w-14 h-14 rounded-full flex items-center justify-center border-4 transition-all duration-300 
                                        ${isCompleted ? 'bg-theme border-theme text-slate-900 shadow-[0_0_25px_rgba(12,239,211,0.6)] cursor-pointer hover:scale-110' : 
                                          isCurrent ? 'bg-white dark:bg-slate-950 border-theme text-slate-900 dark:text-white cursor-default' : 
                                          'bg-white dark:bg-slate-950 border-slate-100 dark:border-slate-800 text-slate-200 dark:text-slate-700'}"
                                    >
                                        ${isCompleted ? '<i data-lucide="check" class="w-7 h-7"></i>' : `<span class="text-base font-black">${i}</span>`}
                                    </button>
                                    <div class="flex flex-col items-center min-h-[50px] w-full px-2">
                                        ${choice ? `
                                            <span class="text-[16px] font-black text-center text-slate-800 dark:text-white animate-in slide-in-from-top-4 leading-tight">${choice.keyword}</span>
                                        ` : `
                                            <span class="text-[11px] font-black uppercase tracking-[0.3em] ${isCurrent ? 'text-slate-400 dark:text-white/40' : 'text-transparent'}">Step ${i}</span>
                                        `}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        const renderSelectionPhase = async () => {
            showSection('section-selection');
            renderStepper();
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';

            if (state.step === 1) {
                FIRST_STEP_OPTIONS.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = `group p-6 border rounded-[3.5rem] text-left transition-all flex items-center gap-8 shadow-sm bg-white dark:bg-slate-950/30 border-slate-100 dark:border-white/5 hover:border-slate-300 dark:hover:border-white/20 hover:bg-slate-50 dark:hover:bg-slate-950/50`;
                    btn.innerHTML = `
                        <div class="w-20 h-20 rounded-[2.5rem] flex items-center justify-center border border-slate-100 dark:border-white/5 bg-theme/10 text-theme group-hover:scale-110 transition-transform shadow-inner">
                            <i data-lucide="${opt.icon}" class="w-8 h-8"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-black text-2xl transition-colors text-slate-800 dark:text-white">${opt.keyword}</div>
                            <div class="text-sm mt-2 font-medium tracking-wide text-slate-400 dark:text-white/30 leading-tight">${opt.example}</div>
                        </div>
                        <i data-lucide="arrow-right" class="w-8 h-8 opacity-0 group-hover:opacity-100 transition-all translate-x-4 group-hover:translate-x-0 text-theme"></i>
                    `;
                    btn.onclick = () => window.handleChoice(opt);
                    grid.appendChild(btn);
                });
                lucide.createIcons();
            } else {
                renderOptions(state.options);
            }
        };

        const renderOptions = (options) => {
            const grid = document.getElementById('options-grid');
            grid.innerHTML = options.map(opt => `
                <button onclick='window.handleChoice(${JSON.stringify(opt).replace(/'/g, "&#39;")})' class="group p-6 border rounded-[3.5rem] text-left transition-all flex items-center gap-8 shadow-sm bg-white dark:bg-slate-950/30 border-slate-100 dark:border-white/5 hover:border-slate-300 dark:hover:border-white/20 hover:bg-slate-50 dark:hover:bg-slate-950/50">
                    <div class="flex-1">
                       <div class="font-black text-2xl text-slate-800 dark:text-white group-hover:text-cyan-400 transition-colors">${opt.keyword}</div>
                       <div class="text-sm mt-2 font-medium tracking-wide text-slate-400 dark:text-white/30 leading-tight">${opt.example}</div>
                    </div>
                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform border border-slate-100 dark:border-white/5 bg-theme/10">
                        <i data-lucide="arrow-right" class="w-7 h-7 text-theme"></i>
                    </div>
                </button>
            `).join('');
            lucide.createIcons();
        };

        window.handleChoice = async (choiceObj) => {
            state.choices.push(choiceObj);
            if (state.choices.length < 3) {
                state.step++;
                renderStepper();
                document.getElementById('options-grid').innerHTML = `
                    <div class="flex flex-col items-center py-24 space-y-8 animate-pulse text-slate-400">
                        <div class="w-16 h-16 border-4 border-slate-100 dark:border-white/5 border-t-theme rounded-full animate-spin"></div>
                        <p class="font-black tracking-widest uppercase text-xs">AI Facilitator thinking...</p>
                    </div>
                `;

                const mainCategory = state.choices[0].keyword;
                const currentKeyword = choiceObj.keyword;
                const systemPrompt = `You are a specialized Daily Facilitator for Woowa Course. Task: Suggest 4 sub-options for the category [${mainCategory} > ${currentKeyword}]. STRICT NEGATIVE CONSTRAINT: The suggested keywords MUST NOT include primary categories: "수다", "활동", "논의", "게임". DOMAIN RULES: - If "수다": Casual lifestyle ONLY. - If "활동": Physical/sensory tasks. - If "논의": Debates or Technical Quizzes. - If "게임": Pure fun games ONLY. Output JSON with 4 unique 'keyword' and 'example' pairs in Korean.`;
                
                try {
                    const result = await fetchOptionsWithRetry(`Suggest next level for: [${currentKeyword}]. Path: ${state.choices.map(c => c.keyword).join(' > ')}`, systemPrompt);
                    state.options = result.options;
                    renderOptions(state.options);
                } catch (e) { 
                    console.error(e);
                    document.getElementById('options-grid').innerHTML = `<p class="text-red-500 text-center font-bold">네트워크 오류가 발생했습니다. 다시 선택해주세요.</p>`;
                    state.choices.pop();
                    state.step--;
                }
            } else {
                fetchFinalPlanWithRetry();
            }
        };

        const fetchOptionsWithRetry = async (prompt, sys, retry = 0) => {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: sys }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    options: { 
                                        type: "ARRAY", 
                                        items: { 
                                            type: "OBJECT", 
                                            properties: { keyword: { type: "STRING" }, example: { type: "STRING" } },
                                            required: ["keyword", "example"]
                                        }, 
                                        minItems: 4, maxItems: 4 
                                    }
                                }
                            }
                        }
                    })
                });
                if (!response.ok) throw new Error('API failed');
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (e) {
                if (retry < 5) {
                    const delay = Math.pow(2, retry) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                    return fetchOptionsWithRetry(prompt, sys, retry + 1);
                }
                throw e;
            }
        };

        const fetchFinalPlanWithRetry = async (retry = 0) => {
            state.step = 4;
            showSection('section-loading');
            document.getElementById('loading-path').innerText = `경로: ${state.choices.map(c => c.keyword).join(' → ')}`;

            const systemPrompt = `You are a creative Daily Facilitator. Theme: Light, Fresh, Strictly based on path: [${state.choices.map(c => c.keyword).join(' > ')}]. Total time: ${state.duration}m. Create Title, Catchphrase, Materials, and 3-4 steps totaling ${state.duration}m. Each step MUST have 'time' (e.g., 5분), 'action' (keyword), 'desc' (instructions). Respond in Korean. JSON format.`;
            const userPrompt = `Generate plan for ${state.crewCount} students. Date: ${state.date}.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    title: { type: "STRING" },
                                    catchphrase: { type: "STRING" },
                                    materials: { type: "STRING" },
                                    steps: { 
                                        type: "ARRAY", 
                                        items: {
                                            type: "OBJECT",
                                            properties: { time: { type: "STRING" }, action: { type: "STRING" }, desc: { type: "STRING" } },
                                            required: ["time", "action", "desc"]
                                        } 
                                    },
                                    benefitKeyword: { type: "STRING" }
                                }
                            }
                        }
                    })
                });
                if (!response.ok) throw new Error('API failed');
                const data = await response.json();
                state.finalResult = JSON.parse(data.candidates[0].content.parts[0].text);
                renderFinalResult();
            } catch (e) { 
                if (retry < 5) {
                    const delay = Math.pow(2, retry) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                    return fetchFinalPlanWithRetry(retry + 1);
                }
                console.error(e);
                alert("결과 생성 중 오류가 발생했습니다. 이전 단계로 돌아갑니다.");
                handleBack();
            }
        };

        const renderFinalResult = () => {
            showSection('section-result');
            const res = state.finalResult;
            document.getElementById('res-date').innerText = res.date || state.date;
            document.getElementById('res-crew').innerText = `${res.crewCount || state.crewCount} Crews`;
            document.getElementById('res-title').innerText = res.title;
            document.getElementById('res-catchphrase').innerText = `"${res.catchphrase}"`;
            
            // Materials & Benefit with Tooltip
            const matEl = document.getElementById('res-materials');
            const matTip = document.getElementById('res-materials-tooltip');
            matEl.innerText = res.materials || '준비물 없음';
            matTip.innerText = res.materials || '준비물 없음';

            const benEl = document.getElementById('res-benefit');
            const benTip = document.getElementById('res-benefit-tooltip');
            benEl.innerText = res.benefitKeyword;
            benTip.innerText = res.benefitKeyword;

            const saveContainer = document.getElementById('save-status-container');
            if (!state.isSaved) {
                saveContainer.innerHTML = `
                    <div class="px-2">
                        <button onclick="window.confirmAndSave()" class="w-full py-6 border-4 rounded-[3rem] font-black text-xl flex items-center justify-center gap-4 transition-all hover:bg-cyan-500/10 active:scale-95 border-theme text-theme">
                            <i data-lucide="check" class="w-8 h-8" stroke-width="4"></i>
                            오늘의 주제로 확정하고 기록하기
                        </button>
                    </div>
                `;
            } else {
                saveContainer.innerHTML = `
                    <div class="px-2">
                        <div class="w-full py-6 bg-cyan-500/10 border-2 border-cyan-500/20 rounded-[3rem] font-black text-xl flex items-center justify-center gap-4 text-cyan-400 animate-in zoom-in">
                            <i data-lucide="check" class="w-8 h-8" stroke-width="4"></i>
                            달력에 기록되었습니다
                        </div>
                    </div>
                `;
            }

            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = res.steps.map((s, i) => `
                <div onclick="window.focusStep(${i})" class="flex flex-col p-8 rounded-[4rem] border transition-all cursor-pointer group ${state.focusedStepIndex === i ? 'bg-cyan-50 dark:bg-white/10 border-cyan-200 dark:border-cyan-400/50 shadow-xl' : 'bg-white dark:bg-white/5 border-slate-100 dark:border-white/5 hover:border-slate-200 dark:hover:border-white/10 shadow-sm'}">
                    <div class="flex gap-8 items-center">
                        <div class="flex flex-col items-center shrink-0 w-24 border-r dark:border-white/10 border-slate-100 pr-8">
                            <span class="text-[11px] font-black opacity-40 uppercase tracking-tighter ${state.focusedStepIndex === i ? 'text-theme opacity-100' : 'text-slate-400 dark:text-white/40'}">${s.time}</span>
                            <span class="text-4xl font-black leading-none mt-3 transition-colors ${state.focusedStepIndex === i ? 'text-theme' : 'text-[#0CEFD3] opacity-10 group-hover:opacity-100'}">${i+1}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center text-slate-800 dark:text-white">
                                <div class="font-black text-2xl">${s.action}</div>
                                <i data-lucide="${state.focusedStepIndex === i ? 'chevron-up' : 'chevron-down'}" class="w-6 h-6 opacity-20 text-slate-800 dark:text-white"></i>
                            </div>
                            ${state.focusedStepIndex !== i ? `<div class="text-sm font-medium truncate w-64 mt-1 opacity-40 text-slate-500 dark:text-white/60 leading-tight">${s.desc}</div>` : ''}
                        </div>
                    </div>
                    ${state.focusedStepIndex === i ? `
                        <div class="mt-8 pt-8 border-t border-slate-100 dark:border-white/5 flex flex-col items-center animate-in fade-in duration-500">
                            <p class="text-center text-base font-medium mb-10 px-10 leading-relaxed opacity-60 italic text-slate-600 dark:text-white/80">"${s.desc}"</p>
                            <div id="timer-target-${i}"></div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            if (state.focusedStepIndex !== -1 && res.steps[state.focusedStepIndex]) {
                renderTimer(state.focusedStepIndex, res.steps[state.focusedStepIndex].time);
            }
            lucide.createIcons();
        };

        window.focusStep = (idx) => {
            state.focusedStepIndex = state.focusedStepIndex === idx ? -1 : idx;
            renderFinalResult();
        };

        const renderTimer = (idx, timeStr) => {
            const target = document.getElementById(`timer-target-${idx}`);
            if (!target) return;

            const parseTime = (str) => {
                const match = str.match(/(\d+)/);
                return match ? parseInt(match[1]) * 60 : 300; 
            };

            const total = parseTime(timeStr);
            let left = total;
            let active = false;
            let timerId = null;

            const updateDisplay = () => {
                const perc = (left / total) * 100;
                const m = Math.floor(left / 60);
                const s = left % 60;
                const timeText = `${m}:${s < 10 ? '0' : ''}${s}`;
                const offset = 741 - (741 * perc) / 100;

                target.innerHTML = `
                    <div class="flex flex-col items-center gap-6 py-4">
                        <div id="circle-click-${idx}" class="relative w-64 h-64 cursor-pointer group active:scale-95 transition-all">
                            <svg class="w-full h-full -rotate-90">
                                <circle cx="128" cy="128" r="118" fill="none" stroke="${state.isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'}" stroke-width="12" />
                                <circle cx="128" cy="128" r="118" fill="none" stroke="${THEME_COLOR}" stroke-width="12" stroke-dasharray="741" stroke-dashoffset="${offset}" stroke-linecap="round" class="transition-all duration-1000 ease-linear shadow-[0_0_15px_#0CEFD3]" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-7xl font-black font-mono tracking-tighter ${left === 0 ? 'text-red-500' : state.isDarkMode ? 'text-white' : 'text-slate-800'}">${timeText}</span>
                                <div class="flex items-center gap-2 mt-5 px-5 py-2 rounded-full transition-all ${active ? 'bg-amber-500 text-slate-900' : 'bg-cyan-400 text-slate-900 shadow-md'}">
                                    <i data-lucide="${active ? 'pause' : 'play'}" class="w-4 h-4"></i>
                                    <span class="text-xs font-black uppercase tracking-widest text-slate-900">${active ? '진행중' : '중지됨'}</span>
                                </div>
                            </div>
                        </div>
                        <button id="reset-btn-${idx}" class="flex items-center gap-2 px-8 py-3 rounded-full border transition-all active:scale-90 font-black text-xs uppercase tracking-widest ${state.isDarkMode ? 'bg-white/5 border-white/10 text-white/30 hover:text-white' : 'bg-slate-100 border-slate-200 text-slate-400 hover:text-slate-600 shadow-sm'}">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i> 타이머 초기화
                        </button>
                    </div>
                `;
                lucide.createIcons();

                document.getElementById(`circle-click-${idx}`).onclick = (e) => {
                    e.stopPropagation();
                    active = !active;
                    if (active) {
                        timerId = setInterval(() => {
                            if (left > 0) {
                                left--;
                                updateDisplay();
                            } else {
                                active = false;
                                clearInterval(timerId);
                                updateDisplay();
                            }
                        }, 1000);
                    } else {
                        clearInterval(timerId);
                        updateDisplay();
                    }
                };

                document.getElementById(`reset-btn-${idx}`).onclick = (e) => {
                    e.stopPropagation();
                    active = false;
                    clearInterval(timerId);
                    left = total;
                    updateDisplay();
                };
            };

            updateDisplay();
        };

        window.confirmAndSave = async () => {
            if (!state.user || !state.finalResult || state.isSaved) return;
            try {
                const col = collection(db, 'artifacts', appId, 'users', state.user.uid, 'history');
                await addDoc(col, {
                    ...state.finalResult,
                    date: state.date,
                    crewCount: state.crewCount,
                    meetingDuration: state.duration,
                    timestamp: serverTimestamp()
                });
                state.isSaved = true;
                renderFinalResult();
            } catch (e) { console.error(e); }
        };

        window.handleBack = () => {
            if (state.step === 4) {
                state.step = 3;
                state.choices.pop();
                renderSelectionPhase();
            } else if (state.step > 1) {
                state.step--;
                state.choices.pop();
                renderSelectionPhase();
            } else {
                state.step = 0;
                showSection('section-setup');
            }
        };

        window.goToStep = (s) => {
            state.step = s;
            state.choices = state.choices.slice(0, s-1);
            renderSelectionPhase();
        };

        window.resetApp = () => {
            state.step = 0;
            state.choices = [];
            state.options = [];
            state.finalResult = null;
            state.isSaved = false;
            showSection('section-setup');
        };

        // --- Calendar Logic ---

        window.openCalendar = () => {
            state.showCalendar = true;
            document.getElementById('calendar-modal').classList.remove('hidden');
            renderCalendarUI();
        };

        window.closeCalendar = () => {
            state.showCalendar = false;
            document.getElementById('calendar-modal').classList.add('hidden');
        };

        const renderCalendarUI = () => {
            const content = document.getElementById('calendar-content');
            const date = state.calendarMonth;
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const yearMonthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            const historyMap = state.history.reduce((acc, item) => {
                acc[item.date] = (acc[item.date] || []).concat(item);
                return acc;
            }, {});

            let daysHtml = '';
            for (let i = 0; i < firstDay; i++) daysHtml += '<div></div>';
            for (let i = 1; i <= lastDate; i++) {
                const fullDate = `${yearMonthStr}-${String(i).padStart(2, '0')}`;
                const records = historyMap[fullDate];
                const isToday = new Date().toISOString().split('T')[0] === fullDate;
                
                daysHtml += `
                    <button onclick="${records ? `window.viewHistoryDetail('${records[0].id}')` : ''}"
                        class="relative aspect-square rounded-2xl flex flex-col items-center justify-center transition-all ${records ? (state.isDarkMode ? 'bg-white/5 border border-white/10 hover:border-cyan-400/50' : 'bg-slate-50 border border-slate-100 hover:border-cyan-400 shadow-sm') : 'opacity-10 cursor-default'}">
                        <span class="text-sm font-black ${isToday ? 'text-cyan-400' : 'text-slate-800 dark:text-white'}">${i}</span>
                        ${records ? `<div class="absolute bottom-2 w-1.5 h-1.5 rounded-full shadow-[0_0_8px_#0CEFD3] bg-theme"></div>` : ''}
                    </button>
                `;
            }

            content.innerHTML = `
                <div class="w-full">
                    <div class="flex justify-between items-center mb-8 px-2">
                        <button onclick="window.changeCalendarMonth(-1)" class="p-3 hover:bg-slate-100 dark:hover:bg-white/5 rounded-2xl transition-all text-slate-800 dark:text-white"><i data-lucide="chevron-left"></i></button>
                        <h3 class="text-xl font-black text-slate-800 dark:text-white">${year}년 ${month + 1}월</h3>
                        <button onclick="window.changeCalendarMonth(1)" class="p-3 hover:bg-slate-100 dark:hover:bg-white/5 rounded-2xl transition-all text-slate-800 dark:text-white"><i data-lucide="chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 mb-4 px-2 text-slate-400 dark:text-white/20">
                        ${['일', '월', '화', '수', '목', '금', '토'].map(d => `<div class="text-center text-[10px] font-black uppercase tracking-widest leading-none">${d}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-2 px-2 text-slate-800 dark:text-white">${daysHtml}</div>
                    
                    <div class="mt-16 space-y-4 px-2 text-slate-800 dark:text-white">
                        <h4 class="text-[11px] font-black opacity-30 uppercase tracking-widest mb-6 text-slate-400 dark:text-white/40">최근 기록 목록</h4>
                        ${state.history.map(item => `
                            <button onclick="window.viewHistoryDetail('${item.id}')" class="w-full p-10 border rounded-[4rem] text-left transition-all flex items-center justify-between group bg-white dark:bg-white/5 border-slate-100 dark:border-transparent hover:border-cyan-400 dark:hover:border-white/10 shadow-sm">
                                <div class="text-slate-800 dark:text-white">
                                    <div class="text-[11px] font-black mb-3 opacity-30 uppercase tracking-[0.4em] text-slate-400 dark:text-white/40">${item.date} • ${item.crewCount} Crews</div>
                                    <div class="font-black text-3xl group-hover:text-cyan-400 transition-colors leading-none">${item.title}</div>
                                </div>
                                <i data-lucide="arrow-right" class="w-8 h-8 opacity-10 group-hover:opacity-100 group-hover:translate-x-2 transition-all text-theme"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        window.changeCalendarMonth = (off) => {
            state.calendarMonth = new Date(state.calendarMonth.getFullYear(), state.calendarMonth.getMonth() + off, 1);
            renderCalendarUI();
        };

        window.viewHistoryDetail = (id) => {
            const item = state.history.find(h => h.id === id);
            if (item) {
                state.finalResult = item;
                state.date = item.date;
                state.crewCount = item.crewCount;
                state.duration = item.meetingDuration || 20;
                state.isSaved = true;
                state.step = 4;
                state.focusedStepIndex = 0;
                closeCalendar();
                renderFinalResult();
            }
        };

        // --- Auth & Sync ---
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (!user) {
                signInAnonymously(auth);
            } else {
                const col = collection(db, 'artifacts', appId, 'users', user.uid, 'history');
                onSnapshot(col, (snap) => {
                    state.history = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => new Date(b.timestamp?.toDate()) - new Date(a.timestamp?.toDate()));
                    if (state.showCalendar) renderCalendarUI();
                }, (err) => {
                    console.error("Firestore sync error:", err);
                });
            }
        });

        // Init setup
        document.getElementById('input-date').value = state.date;
        lucide.createIcons();

    </script>
</body>
</html>
