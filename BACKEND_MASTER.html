<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Master - Standard Edition</title>
    <style>
        :root {
            /* Clean White & Professional Blue Theme */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-bg: #f1f5f9;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border-color: #e2e8f0;
            --wrong-color: #ef4444;
            --correct-color: #22c55e;
            --star-color: #fbbf24;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0; line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; position: relative; }

        header { text-align: center; margin-bottom: 50px; position: relative; padding-top: 20px; }
        header h1 { font-size: 2.5rem; margin: 10px 0; color: var(--primary-color); font-weight: 800; letter-spacing: -0.02em; }
        header p { color: var(--text-sub); font-size: 1.1rem; }

        /* Simplified Archive Icon Button (No count badge) */
        .archive-trigger {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .archive-trigger:hover { transform: scale(1.1); border-color: var(--primary-color); box-shadow: var(--shadow-lg); }
        .archive-trigger span { font-size: 1.6rem; }

        .section-title {
            font-size: 1.4rem; font-weight: 800; margin: 50px 0 5px 0;
            display: flex; align-items: center; justify-content: space-between;
            color: var(--text-main); border-left: 5px solid var(--primary-color); padding-left: 15px;
        }

        /* Sub-instruction style */
        .section-desc {
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-bottom: 20px;
            padding-left: 20px;
        }

        /* Prominent Custom Course (Main Feature) */
        .custom-course-section {
            background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
            border-radius: 28px;
            padding: 30px;
            border: 2px solid #dbeafe;
            box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.05);
            margin-bottom: 20px;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Category Grid (General) */
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        
        /* Specific Grid for Basic Course to force 5 in one row on desktop */
        .basic-course-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        @media (max-width: 768px) {
            .basic-course-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        .category-card {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px;
            padding: 20px 10px; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow-sm);
            position: relative;
        }
        .category-card:hover { transform: translateY(-6px); border-color: var(--primary-color); box-shadow: var(--shadow-lg); }
        .category-card span { font-size: 2rem; display: block; margin-bottom: 10px; }
        .category-card h3 { font-size: 0.95rem; margin: 0; color: var(--text-main); font-weight: 700; word-break: keep-all; }

        .custom-add-card { border: 2px dashed var(--primary-color); background: #f8fafc; color: var(--primary-color); width: 100%; transition: all 0.3s; cursor: pointer; text-align: center; }
        .custom-add-card:hover { background: #eff6ff; transform: scale(1.01); }
        .grid-add-card { width: auto; padding: 20px 10px; }

        /* View Panels */
        .view-panel { display: none; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 24px; padding: 40px; box-shadow: var(--shadow-lg); animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .panel-actions { display: flex; gap: 10px; align-items: center; }

        .scroll-content { background: var(--secondary-bg); padding: 25px; border-radius: 12px; max-height: 300px; overflow-y: auto; margin-bottom: 30px; border: 1px solid var(--border-color); white-space: pre-wrap; color: var(--text-main); font-size: 1rem; }

        /* Setup Form */
        .setup-group { margin-bottom: 25px; }
        .setup-label { display: block; margin-bottom: 12px; font-weight: 700; color: var(--text-main); }
        .setup-row { display: flex; gap: 12px; flex-wrap: wrap; }
        .radio-btn { flex: 1; min-width: 90px; text-align: center; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; background: #fff; transition: all 0.2s; font-weight: 600; }
        .radio-btn.active { border-color: var(--primary-color); background: #eff6ff; color: var(--primary-color); }

        .num-picker { display: flex; align-items: center; justify-content: space-between; background: var(--secondary-bg); padding: 14px 25px; border-radius: 12px; width: 100%; box-sizing: border-box; margin-bottom: 30px; }
        .num-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: #fff; color: var(--primary-color); font-size: 1.5rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); transition: 0.2s; }
        .num-btn:hover { background: var(--primary-color); color: #fff; }
        .num-display { font-size: 2rem; font-weight: 900; color: var(--primary-color); }

        /* Archive UI (Line Tabs) */
        .archive-tabs { display: flex; gap: 0; margin-bottom: 30px; border-bottom: 2px solid var(--border-color); }
        .archive-tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; font-weight: 800; transition: all 0.2s; background: transparent; color: var(--text-sub); border-bottom: 4px solid transparent; margin-bottom: -2px; }
        .archive-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        
        .archive-list { display: flex; flex-direction: column; gap: 15px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .archive-item { background: var(--bg-card); border: 1px solid var(--border-color); padding: 20px; border-radius: 16px; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .archive-item:hover { border-color: var(--primary-color); transform: translateX(5px); box-shadow: var(--shadow-sm); }
        .archive-item-info { flex: 1; }
        .archive-item-info h4 { margin: 0 0 5px 0; font-size: 1.05rem; font-weight: 700; color: var(--text-main); }
        .archive-item-info p { margin: 0; font-size: 0.85rem; color: var(--text-sub); }

        /* Quiz UI */
        .quiz-container { display: none; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 24px; padding: 40px; box-shadow: var(--shadow-lg); position: relative; }
        .progress-bar { height: 10px; background: var(--border-color); border-radius: 10px; margin-bottom: 30px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }
        .question-box h2 { font-size: 1.5rem; margin-bottom: 30px; font-weight: 800; line-height: 1.4; color: var(--text-main); }
        .option-btn { width: 100%; padding: 20px; text-align: left; border: 1px solid var(--border-color); background: #fff; border-radius: 12px; cursor: pointer; font-size: 1.1rem; color: var(--text-main); margin-bottom: 14px; transition: all 0.2s; }
        .option-btn:hover:not(:disabled) { border-color: var(--primary-color); background: #f0f7ff; }
        .option-btn.correct { border-color: var(--correct-color); background: #f0fdf4; color: var(--correct-color); font-weight: 700; }
        .option-btn.wrong { border-color: var(--wrong-color); background: #fef2f2; color: var(--wrong-color); font-weight: 700; }

        /* Star Button Styling */
        .btn-star {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-sub);
        }
        .btn-star:hover { transform: scale(1.2); }
        .btn-star.active { color: var(--star-color); }
        .btn-star svg { width: 32px; height: 32px; fill: none; stroke: currentColor; stroke-width: 2; transition: all 0.2s; }
        .btn-star.active svg { fill: var(--star-color); stroke: var(--star-color); }

        .btn { padding: 14px 28px; background: var(--primary-color); color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .btn:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .btn-sub { background: #f1f5f9; color: var(--text-main); border: 1px solid var(--border-color); width: auto; }
        .btn-sub:hover { background: #e2e8f0; }
        .btn-danger { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; width: auto; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(6px); }
        .modal-content { background: var(--bg-card); padding: 40px; border-radius: 28px; max-width: 550px; width: 90%; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); }
        .modal-content input, .modal-content textarea { width: 100%; padding: 16px; background: #f8fafc; border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-main); margin-top: 12px; margin-bottom: 18px; box-sizing: border-box; font-family: inherit; font-size: 1rem; }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 3000; flex-direction: column; justify-content: center; align-items: center; }
        .loader-ring { width: 60px; height: 60px; border: 5px solid var(--border-color); border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: #fff; padding: 14px 30px; border-radius: 14px; opacity: 0; transition: 0.3s; z-index: 4000; font-weight: 600; box-shadow: var(--shadow-lg); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <!-- Simplified Archive Icon Button (No Badge) -->
    <div class="archive-trigger" onclick="openArchiveView()" title="ë³´ê´€í•¨ ì—´ê¸°">
        <span>ğŸ“¦</span>
    </div>

    <header>
        <h1>ğŸš€ Backend Master</h1>
        <p>AI ë§ì¶¤ í•™ìŠµìœ¼ë¡œ ì™„ì„±í•˜ëŠ” ë°±ì—”ë“œ ì»¤ë¦¬ì–´</p>
    </header>

    <!-- 1. Home View -->
    <div id="home-view">
        <div class="section-title">âœ¨ ë§ì¶¤í˜• í•™ìŠµ ì½”ìŠ¤ (AI ë¬¸ì œ ìƒì„±)</div>
        <p class="section-desc">ê³µë¶€í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ë©´ ê·¸ì— ë§ëŠ” AI ë¬¸ì œë¥¼ ì œê³µí•˜ê±°ë‚˜, í•™ìŠµëª…ì— ë§ëŠ” ë¬¸ì œë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>
        <div class="custom-course-section" id="custom-course-section">
            <!-- Dynamically rendered: Full box if empty, grid if not -->
        </div>

        <div class="section-title">ğŸ“š ê¸°ë³¸ í•™ìŠµ ì½”ìŠ¤</div>
        <div class="basic-course-grid">
            <div class="category-card" onclick="openQuizSetup('network', 'ë„¤íŠ¸ì›Œí¬')"><span>ğŸŒ</span><h3>ë„¤íŠ¸ì›Œí¬</h3></div>
            <div class="category-card" onclick="openQuizSetup('java', 'ìë°”')"><span>â˜•</span><h3>ìë°”</h3></div>
            <div class="category-card" onclick="openQuizSetup('spring', 'ìŠ¤í”„ë§')"><span>ğŸƒ</span><h3>ìŠ¤í”„ë§</h3></div>
            <div class="category-card" onclick="openQuizSetup('cs', 'CS ê¸°ì´ˆ')"><span>ğŸ’»</span><h3>CS ê¸°ì´ˆ</h3></div>
            <div class="category-card" onclick="openQuizSetup('algorithm', 'ì•Œê³ ë¦¬ì¦˜')"><span>ğŸ§©</span><h3>ì•Œê³ ë¦¬ì¦˜</h3></div>
        </div>
    </div>

    <!-- 2. Archive View (Underline Tabs) -->
    <div id="archive-view" class="view-panel">
        <div class="panel-header">
            <h2 style="margin:0; color:var(--primary-color)">ë‚´ í•™ìŠµ ë³´ê´€í•¨</h2>
            <button class="btn btn-sub" onclick="goHome()">ë‹«ê¸°</button>
        </div>
        <div class="archive-tabs">
            <div id="tab-saved" class="archive-tab active" onclick="switchArchiveTab('saved')">ì €ì¥ëœ ë¬¸ì œ</div>
            <div id="tab-wrong" class="archive-tab" onclick="switchArchiveTab('wrong')">ì˜¤ë‹µ ë…¸íŠ¸</div>
        </div>
        <div id="archive-list-area" class="archive-list">
            <!-- Items rendered here -->
        </div>
        <div id="archive-empty-msg" style="text-align:center; padding:60px 20px; color:var(--text-sub); font-weight: 600;">
            <!-- Dynamic message: "ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤." or "í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤." -->
        </div>
        <div id="archive-study-btn-container" style="margin-top:30px; text-align:center;">
            <button class="btn" style="width:auto; padding: 14px 40px;" onclick="studySelectedArchive()">
                ğŸ”¥ ì´ ë¦¬ìŠ¤íŠ¸ë¡œ í•™ìŠµ ì‹œì‘ (ìµœëŒ€ 15ë¬¸ì œ)
            </button>
        </div>
    </div>

    <!-- 3. Quiz Setup View -->
    <div id="setup-view" class="view-panel">
        <div class="panel-header">
            <h2 id="setup-title" style="margin:0; color:var(--primary-color)">í•™ìŠµ ì„¤ì •</h2>
            <button class="btn btn-sub" onclick="goHome()">ì·¨ì†Œ</button>
        </div>
        <div class="setup-group">
            <label class="setup-label">ë‚œì´ë„ ì„ íƒ</label>
            <div class="setup-row" id="diff-selector">
                <div class="radio-btn" data-val="easy" onclick="selectDifficulty(this)">í•˜ (ì´ˆë³´)</div>
                <div class="radio-btn active" data-val="medium" onclick="selectDifficulty(this)">ì¤‘ (ì¼ë°˜)</div>
                <div class="radio-btn" data-val="hard" onclick="selectDifficulty(this)">ìƒ (ì‹¬í™”)</div>
            </div>
        </div>
        <div class="setup-group">
            <label class="setup-label">ë¬¸ì œ ìˆ˜ ì„ íƒ</label>
            <div class="num-picker">
                <button class="num-btn" onclick="adjustCount(-5)">-</button>
                <span class="num-display" id="count-display">15</span>
                <button class="num-btn" onclick="adjustCount(5)">+</button>
            </div>
        </div>
        <button class="btn" onclick="startAIQuizWithSettings()">
            âš¡ AI í€´ì¦ˆ ìƒì„± ë° ì‹œì‘
        </button>
    </div>

    <!-- 4. Detail View -->
    <div id="detail-view" class="view-panel">
        <div class="panel-header">
            <h2 id="detail-title" style="margin:0; color:var(--primary-color)">í•™ìŠµ ì£¼ì œ</h2>
            <div class="panel-actions">
                <button class="btn btn-sub" id="edit-category-btn">ìˆ˜ì •</button>
                <button class="btn btn-danger" id="delete-category-btn">ì‚­ì œ</button>
                <button class="btn btn-sub" onclick="goHome()">ë‹«ê¸°</button>
            </div>
        </div>
        <div class="scroll-content" id="detail-content"></div>
        <button class="btn" id="go-setup-btn">ğŸ§  í•™ìŠµ ì„¤ì • í›„ ì‹œì‘</button>
    </div>

    <!-- 5. Quiz Main View -->
    <div id="quiz-view" class="quiz-container">
        <div class="panel-header">
            <span id="quiz-title-text" style="font-weight: 800; color: var(--primary-color);">í•™ìŠµ ì¤‘</span>
            <div class="panel-actions">
                <!-- Simplified Star Save Button -->
                <button id="save-quiz-btn" class="btn-star" onclick="toggleSaveCurrentQuiz()" title="ë¬¸ì œ ì €ì¥">
                    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                </button>
                <button class="btn btn-sub" onclick="openExitModal()">ì¢…ë£Œ</button>
            </div>
        </div>
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        <div id="question-area"></div>
        <div id="explanation" class="explanation-box">
            <h4 style="margin:0 0 10px 0; color: var(--primary-color);">ğŸ’¡ í•´ì„¤ ê°€ì´ë“œ</h4>
            <p id="explanation-text" style="margin:0; font-size:0.95rem;"></p>
        </div>
        <div class="nav-controls" style="display:flex; justify-content:space-between; margin-top:30px; gap: 15px;">
            <button id="prev-btn" class="btn btn-sub" style="flex:1" onclick="prevQuestion()">ì´ì „</button>
            <button id="next-nav-btn" class="btn" style="flex:1" onclick="nextQuestion()">ë‹¤ìŒ</button>
        </div>
    </div>

    <!-- 6. Result View -->
    <div id="result-view" class="view-panel" style="text-align: center;">
        <h2 id="result-title" style="color:var(--primary-color); font-weight:800;">MISSION COMPLETE</h2>
        <div id="result-score" style="font-size: 4rem; font-weight: 900; margin: 30px 0; color:var(--text-main);">0 / 0</div>
        <div id="result-msg"></div>
        <button class="btn" onclick="goHome()" style="margin-top: 40px; padding: 18px 60px; width: auto;">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<!-- Modals -->
<div id="custom-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modal-title" style="margin-top:0; color:var(--primary-color)">í•™ìŠµ ì½”ìŠ¤ ì„¤ì •</h3>
        <input type="hidden" id="edit-id">
        <label class="setup-label">í•™ìŠµ ëª…</label>
        <input type="text" id="cat-name" placeholder="ì˜ˆ: Redis ì•„í‚¤í…ì²˜">
        <label class="setup-label">í•™ìŠµ ë°ì´í„° (ì„ íƒ ì‚¬í•­)</label>
        <textarea id="cat-content" placeholder="ê³µë¶€í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ë¹„ì›Œë‘ë©´ AIê°€ í•™ìŠµ ëª…ì„ ë°”íƒ•ìœ¼ë¡œ ê´€ë ¨ ë¬¸ì œë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤."></textarea>
        <div style="display: flex; justify-content: flex-end; gap: 12px;">
            <button class="btn btn-sub" onclick="closeCustomModal()">ì·¨ì†Œ</button>
            <button class="btn" style="width: auto;" onclick="saveCustomCategory()">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>

<div id="exit-modal" class="modal-overlay">
    <div class="modal-content" style="text-align: center; max-width: 400px;">
        <h3 style="margin-top: 0">í•™ìŠµì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
        <div style="display: flex; justify-content: center; gap: 12px; margin-top: 30px;">
            <button class="btn btn-sub" onclick="closeExitModal()">ê³„ì†í•˜ê¸°</button>
            <button class="btn" style="width: auto;" onclick="confirmExit()">í•™ìŠµ ì¢…ë£Œ</button>
        </div>
    </div>
</div>

<div id="loading-overlay">
    <div class="loader-ring"></div>
    <p style="margin-top: 25px; font-weight: 700; color: var(--primary-color);">Gemini AIê°€ ë§ì¶¤í˜• ë¬¸ì œë¥¼ ì„¤ê³„ ì¤‘ì…ë‹ˆë‹¤...</p>
</div>

<div id="toast"></div>

<script>
    const apiKey = "";
    const categoryContexts = {
        network: "ë„¤íŠ¸ì›Œí¬(HTTP/HTTPS, TCP/UDP, DNS, OSI 7ê³„ì¸µ, ë¡œë“œë°¸ëŸ°ì‹±, RESTful API ë“±)",
        java: "ìë°”(JVM êµ¬ì¡°, ê°€ë¹„ì§€ ì»¬ë ‰ì…˜, ê°ì²´ì§€í–¥ 5ì›ì¹™(SOLID), ìë°” ì»¬ë ‰ì…˜ í”„ë ˆì„ì›Œí¬, ë©€í‹°ìŠ¤ë ˆë”© ë“±)",
        spring: "ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬(IoC/DI, AOP, ìŠ¤í”„ë§ ë¶€íŠ¸ ìë™ì„¤ì •, ìŠ¤í”„ë§ ë°ì´í„° JPA, ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ë“±)",
        cs: "ì»´í“¨í„° ì‚¬ì´ì–¸ìŠ¤(OS ìŠ¤ì¼€ì¤„ë§, ê°€ìƒë©”ëª¨ë¦¬, DB íŠ¸ëœì­ì…˜ ê²©ë¦¬ìˆ˜ì¤€, ì¸ë±ìŠ¤ ì•„í‚¤í…ì²˜ ë“±)",
        algorithm: "ì•Œê³ ë¦¬ì¦˜(ìë£Œêµ¬ì¡° ê¸°ì´ˆ, ì •ë ¬ ì•Œê³ ë¦¬ì¦˜, ê·¸ë˜í”„ íƒìƒ‰(BFS/DFS), ë™ì  ê³„íšë²•, ì‹œê°„ ë³µì¡ë„ ë¶„ì„ ë“±)"
    };

    let currentQuizSet = [];
    let currentIdx = 0;
    let quizState = [];
    
    let customCategories = JSON.parse(localStorage.getItem('backend_master_custom') || '[]');
    let savedQuizzes = JSON.parse(localStorage.getItem('backend_master_saved_quizzes') || '[]');
    let wrongQuizzes = JSON.parse(localStorage.getItem('backend_master_wrong_quizzes') || '[]');

    let selectedCatKey = null, selectedCatTitle = null, selectedCatContent = null;
    let currentDifficulty = 'medium', currentCount = 15, currentArchiveTab = 'saved';

    window.onload = () => {
        renderCustomCategories();
        // Storage counts updated internally, no badges in UI
    };

    function renderCustomCategories() {
        const section = document.getElementById('custom-course-section');
        if (!section) return;

        if (customCategories.length === 0) {
            section.innerHTML = `
                <div class="custom-add-card" onclick="openCustomModal()" style="height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 20px;">
                    <span style="font-size: 2.5rem;">â•</span>
                    <p style="font-weight:800; font-size: 1.1rem; margin-top: 10px;">ë‚˜ë§Œì˜ ë§ì¶¤í˜• í•™ìŠµ ì½”ìŠ¤ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”!</p>
                </div>
            `;
        } else {
            section.innerHTML = `<div class="category-grid" id="custom-category-grid"></div>`;
            const grid = document.getElementById('custom-category-grid');
            
            customCategories.forEach(cat => {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `<span>ğŸ“</span><h3>${cat.name}</h3>`;
                card.onclick = () => openDetailView(cat.id);
                grid.appendChild(card);
            });

            const addCard = document.createElement('div');
            addCard.className = 'category-card custom-add-card grid-add-card';
            addCard.innerHTML = `<span>â•</span><p style="font-weight:700;">ì¶”ê°€</p>`;
            addCard.onclick = () => openCustomModal();
            grid.appendChild(addCard);
        }
    }

    function adjustCount(val) {
        currentCount = Math.max(5, Math.min(30, currentCount + val));
        document.getElementById('count-display').innerText = currentCount;
    }

    function selectDifficulty(el) {
        document.querySelectorAll('#diff-selector .radio-btn').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        currentDifficulty = el.getAttribute('data-val');
    }

    function goHome() {
        ['home-view', 'setup-view', 'detail-view', 'quiz-view', 'result-view', 'archive-view'].forEach(v => {
            const el = document.getElementById(v);
            if (el) el.style.display = 'none';
        });
        document.getElementById('home-view').style.display = 'block';
        renderCustomCategories();
    }

    /* Archive Logic */
    function openArchiveView() {
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('archive-view').style.display = 'block';
        switchArchiveTab(currentArchiveTab);
    }

    function switchArchiveTab(tab) {
        currentArchiveTab = tab;
        document.getElementById('tab-saved').classList.toggle('active', tab === 'saved');
        document.getElementById('tab-wrong').classList.toggle('active', tab === 'wrong');
        renderArchiveItems();
    }

    function renderArchiveItems() {
        const list = document.getElementById('archive-list-area');
        const emptyMsg = document.getElementById('archive-empty-msg');
        const studyBtn = document.getElementById('archive-study-btn-container');
        list.innerHTML = '';
        
        const data = currentArchiveTab === 'saved' ? savedQuizzes : wrongQuizzes;
        
        if (data.length === 0) {
            emptyMsg.style.display = 'block';
            emptyMsg.innerText = currentArchiveTab === 'saved' ? "ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤." : "í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.";
            studyBtn.style.display = 'none';
        } else {
            emptyMsg.style.display = 'none';
            studyBtn.style.display = 'block';
            data.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'archive-item';
                div.innerHTML = `
                    <div class="archive-item-info">
                        <h4>${item.q}</h4>
                        <p>ì •ë‹µ: <span style="color:var(--primary-color); font-weight:600;">${item.a}</span></p>
                    </div>
                    <button class="btn btn-danger" style="padding: 10px 15px; font-size:0.85rem;" onclick="deleteArchiveItem(${idx})">ì‚­ì œ</button>
                `;
                list.appendChild(div);
            });
        }
    }

    function deleteArchiveItem(idx) {
        if (currentArchiveTab === 'saved') {
            savedQuizzes.splice(idx, 1);
            localStorage.setItem('backend_master_saved_quizzes', JSON.stringify(savedQuizzes));
        } else {
            wrongQuizzes.splice(idx, 1);
            localStorage.setItem('backend_master_wrong_quizzes', JSON.stringify(wrongQuizzes));
        }
        renderArchiveItems();
    }

    function studySelectedArchive() {
        const pool = currentArchiveTab === 'saved' ? savedQuizzes : wrongQuizzes;
        if (pool.length === 0) return;
        const questions = [...pool].sort(() => Math.random() - 0.5).slice(0, 15);
        startQuizEngine(questions, currentArchiveTab === 'saved' ? 'â­ ì €ì¥ ë¬¸ì œ ë³µìŠµ' : 'âŒ ì˜¤ë‹µ ë³µìŠµ');
    }

    /* Course Detail & Custom Logic */
    function openQuizSetup(key, title, content = null) {
        selectedCatKey = key; selectedCatTitle = title; selectedCatContent = content;
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('archive-view').style.display = 'none';
        document.getElementById('detail-view').style.display = 'none';
        document.getElementById('setup-view').style.display = 'block';
        document.getElementById('setup-title').innerText = `${title} í•™ìŠµ ì„¤ì •`;
    }

    function openDetailView(id) {
        const cat = customCategories.find(c => c.id == id);
        if (!cat) return;
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('detail-view').style.display = 'block';
        document.getElementById('detail-title').innerText = cat.name;
        document.getElementById('detail-content').innerText = cat.content || "(í•™ìŠµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. AIê°€ í•™ìŠµ ëª…ì„ ë°”íƒ•ìœ¼ë¡œ ê´€ë ¨ ë¬¸ì œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.)";
        document.getElementById('edit-category-btn').onclick = (e) => { e.stopPropagation(); openCustomModal(cat.id); };
        document.getElementById('delete-category-btn').onclick = (e) => { e.stopPropagation(); deleteCategory(cat.id); };
        document.getElementById('go-setup-btn').onclick = () => openQuizSetup('custom', cat.name, cat.content);
    }

    function openCustomModal(id = null) {
        const modal = document.getElementById('custom-modal');
        const titleEl = document.getElementById('modal-title');
        const cat = id ? customCategories.find(c => c.id == id) : null;
        if (titleEl) titleEl.innerText = id ? "í•™ìŠµ ì½”ìŠ¤ ìˆ˜ì •" : "ìƒˆ í•™ìŠµ ì½”ìŠ¤ ì¶”ê°€";
        document.getElementById('cat-name').value = cat ? cat.name : "";
        document.getElementById('cat-content').value = cat ? cat.content : "";
        document.getElementById('edit-id').value = id || "";
        modal.style.display = 'flex';
    }

    function closeCustomModal() { document.getElementById('custom-modal').style.display = 'none'; }

    function saveCustomCategory() {
        const name = document.getElementById('cat-name').value.trim();
        const content = document.getElementById('cat-content').value.trim();
        const id = document.getElementById('edit-id').value;
        if (!name) { showToast("í•™ìŠµ ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
        if (id) {
            const idx = customCategories.findIndex(c => c.id == id);
            if (idx > -1) customCategories[idx] = { ...customCategories[idx], name, content };
        } else {
            customCategories.push({ id: Date.now(), name, content });
        }
        localStorage.setItem('backend_master_custom', JSON.stringify(customCategories));
        closeCustomModal();
        renderCustomCategories();
        if (id) openDetailView(id); else goHome();
        showToast("ì½”ìŠ¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function deleteCategory(id) {
        if (confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            customCategories = customCategories.filter(c => c.id != id);
            localStorage.setItem('backend_master_custom', JSON.stringify(customCategories));
            goHome();
        }
    }

    /* AI Quiz Core */
    async function startAIQuizWithSettings() {
        document.getElementById('loading-overlay').style.display = 'flex';
        const context = selectedCatKey === 'custom' ? (selectedCatContent || `ì£¼ì œ: ${selectedCatTitle}`) : categoryContexts[selectedCatKey];
        const diffMap = { 'easy': 'ì´ˆë³´ì ìˆ˜ì¤€', 'medium': 'ì¼ë°˜ì ì¸ ìˆ˜ì¤€', 'hard': 'ì‹¬í™” ìˆ˜ì¤€' };
        const prompt = `ë‹¹ì‹ ì€ ë°±ì—”ë“œ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì œ(${context})ë¥¼ ë°”íƒ•ìœ¼ë¡œ ${currentCount}ê°œì˜ ê°ê´€ì‹ í€´ì¦ˆë¥¼ ë§Œë“œì„¸ìš”. ë‚œì´ë„: ${diffMap[currentDifficulty]}. ë°˜ë“œì‹œ JSONìœ¼ë¡œ ì‘ë‹µ: { "questions": [ { "q": "ì§ˆë¬¸", "a": "ì •ë‹µë¬¸êµ¬", "options": ["ë³´ê¸°1", "ë³´ê¸°2", "ë³´ê¸°3", "ë³´ê¸°4"], "info": "ì •ë‹µ í•´ì„¤" } ] }`;
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
            });
            const result = await response.json();
            const quizData = JSON.parse(result.candidates[0].content.parts[0].text);
            startQuizEngine(quizData.questions, `${selectedCatTitle} (${currentDifficulty.toUpperCase()})`);
        } catch (e) { showToast("AI ì—°ë™ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } finally { document.getElementById('loading-overlay').style.display = 'none'; }
    }

    function startQuizEngine(questions, title) {
        currentQuizSet = questions; currentIdx = 0;
        quizState = currentQuizSet.map(() => ({ isSolved: false, isCorrect: false, userAnswer: '', showExp: false }));
        document.getElementById('quiz-title-text').innerText = title;
        ['setup-view', 'home-view', 'detail-view', 'archive-view'].forEach(v => {
            const el = document.getElementById(v);
            if(el) el.style.display = 'none';
        });
        document.getElementById('quiz-view').style.display = 'block';
        showQuestion();
    }

    function showQuestion() {
        const quiz = currentQuizSet[currentIdx], state = quizState[currentIdx], area = document.getElementById('question-area');
        if (!area) return;
        document.getElementById('progress-fill').style.width = `${((currentIdx + 1) / currentQuizSet.length) * 100}%`;
        document.getElementById('prev-btn').disabled = currentIdx === 0;
        document.getElementById('next-nav-btn').innerText = (currentIdx === currentQuizSet.length - 1) ? "ê²°ê³¼ ë³´ê¸°" : "ë‹¤ìŒ";
        
        // Star Button Logic
        const isSaved = savedQuizzes.some(sq => sq.q === quiz.q);
        const saveBtn = document.getElementById('save-quiz-btn');
        saveBtn.classList.toggle('active', isSaved);

        document.getElementById('explanation').style.display = state.showExp ? 'block' : 'none';
        document.getElementById('explanation-text').innerText = quiz.info;
        
        let html = `<div class="question-box"><span style="color:var(--text-sub); font-size: 0.8rem; font-weight:700;">QUESTION ${currentIdx + 1}/${currentQuizSet.length}</span><h2>${quiz.q}</h2>`;
        quiz.options.forEach(opt => {
            let btnClass = "option-btn";
            if (state.isSolved) {
                if (opt === quiz.a) btnClass += " correct";
                else if (opt === state.userAnswer) btnClass += " wrong";
            }
            html += `<button class="${btnClass}" ${state.isSolved ? 'disabled' : ''} onclick="checkAnswer('${opt}')">${opt}</button>`;
        });
        area.innerHTML = html + `</div>`;
    }

    function checkAnswer(selected) {
        const state = quizState[currentIdx], quiz = currentQuizSet[currentIdx];
        if (state.isSolved) return;
        state.isSolved = true; state.userAnswer = selected;
        state.isCorrect = (selected === quiz.a);
        state.showExp = true; 
        if (!state.isCorrect) {
            if (!wrongQuizzes.some(wq => wq.q === quiz.q)) {
                wrongQuizzes.push(quiz);
                localStorage.setItem('backend_master_wrong_quizzes', JSON.stringify(wrongQuizzes));
            }
        }
        showQuestion();
    }

    function toggleSaveCurrentQuiz() {
        const quiz = currentQuizSet[currentIdx];
        const existingIdx = savedQuizzes.findIndex(sq => sq.q === quiz.q);
        if (existingIdx > -1) { 
            savedQuizzes.splice(existingIdx, 1); 
            showToast("ë³´ê´€í•¨ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        }
        else { 
            savedQuizzes.push(quiz); 
            showToast("ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        }
        localStorage.setItem('backend_master_saved_quizzes', JSON.stringify(savedQuizzes));
        showQuestion();
    }

    function prevQuestion() { if (currentIdx > 0) { currentIdx--; showQuestion(); } }
    function nextQuestion() {
        if (currentIdx < currentQuizSet.length - 1) { currentIdx++; showQuestion(); }
        else { finishQuiz(); }
    }

    function finishQuiz() {
        document.getElementById('quiz-view').style.display = 'none';
        const resultView = document.getElementById('result-view');
        if (resultView) resultView.style.display = 'block';
        const correct = quizState.filter(s => s.isCorrect).length;
        document.getElementById('result-score').innerText = `${correct} / ${currentQuizSet.length}`;
        document.getElementById('result-msg').innerHTML = `<p>${(correct / currentQuizSet.length) >= 0.8 ? "ëŒ€ë‹¨í•©ë‹ˆë‹¤! ì´ ê¸°ì„¸ë¡œ ë°±ì—”ë“œ ë§ˆìŠ¤í„°ê¹Œì§€! ğŸš€" : "í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¤ë‹µì„ í†µí•´ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ì±„ì›Œë³´ì„¸ìš”."}</p>`;
    }

    function openExitModal() { document.getElementById('exit-modal').style.display = 'flex'; }
    function closeExitModal() { document.getElementById('exit-modal').style.display = 'none'; }
    function confirmExit() { closeExitModal(); goHome(); }

    function showToast(msg) {
        const t = document.getElementById('toast');
        if (!t) return;
        t.innerText = msg; t.style.opacity = 1;
        setTimeout(() => { t.style.opacity = 0; }, 2000);
    }
</script>
</body>
</html>
