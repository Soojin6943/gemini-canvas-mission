<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모아 - 똑똑한 소비 & 할 일 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8fafc;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .calendar-day {
            background-color: white;
            min-height: 120px;
            padding: 0.4rem;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .calendar-day:hover {
            background-color: #f1f5f9;
        }

        .calendar-day.selected {
            background-color: #eff6ff;
            box-shadow: inset 0 0 0 2px #3b82f6;
            z-index: 10;
        }

        .calendar-day.today {
            background-color: #f0fdf4;
        }

        .calendar-header-day {
            background-color: #f1f5f9;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: #64748b;
        }

        .todo-item.completed {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .calendar-todo-text {
            font-size: 10px;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0px 2px;
            margin-bottom: 0px;
        }

        .color-chip {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .color-chip:hover { transform: scale(1.1); }
        .color-chip.active { 
            transform: scale(1.2);
            border-color: white;
            box-shadow: 0 0 0 2px #3b82f6;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- 헤더 -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2 tracking-tight">
                    <i data-lucide="layout-dashboard" class="text-blue-600"></i>
                    모아
                </h1>
                <p class="text-gray-500 text-sm">소비와 할 일을 한 곳에서 관리하세요.</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openBudgetModal()" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span class="text-sm font-semibold">예산 설정</span>
                </button>
            </div>
        </header>

        <!-- 대시보드 요약 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative group">
                <div class="flex items-center justify-between mb-1">
                    <p id="budget-label" class="text-xs font-semibold text-gray-400">목표 예산</p>
                    <button onclick="openExtraBudgetModal()" class="text-blue-500 hover:scale-110 transition">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    </button>
                </div>
                <h3 id="display-budget" class="text-xl font-bold text-gray-900 font-mono">₩ 0</h3>
                <p id="extra-budget-badge" class="text-[10px] text-blue-500 font-medium hidden mt-1"></p>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <p class="text-xs font-semibold text-gray-400 mb-1">현재 총 지출</p>
                <h3 id="display-spent" class="text-xl font-bold text-red-500 font-mono">₩ 0</h3>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <p class="text-xs font-semibold text-gray-400 mb-1">남은 생활비</p>
                <h3 id="display-remaining" class="text-xl font-bold text-blue-600 font-mono">₩ 0</h3>
            </div>
        </div>

        <!-- 메인 그리드 -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- 왼쪽: 달력 -->
            <div class="lg:col-span-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="calendar-title" class="text-lg font-bold text-gray-900 tracking-tight">2024년 2월</h2>
                    <div class="flex gap-1">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                </div>
                
                <div class="calendar-grid">
                    <div class="calendar-header-day text-red-400">일</div>
                    <div class="calendar-header-day">월</div>
                    <div class="calendar-header-day">화</div>
                    <div class="calendar-header-day">수</div>
                    <div class="calendar-header-day">목</div>
                    <div class="calendar-header-day">금</div>
                    <div class="calendar-header-day text-blue-400">토</div>
                    <div id="calendar-body" class="contents"></div>
                </div>
            </div>

            <!-- 오른쪽: 상세 정보 사이드바 -->
            <div class="lg:col-span-4 space-y-6">
                <!-- 선택된 날짜 지출 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="selected-date-title" class="text-lg font-bold text-gray-900">지출</h2>
                        <button onclick="openExpenseModal()" class="p-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="daily-expense-list" class="space-y-3 h-[135px] overflow-y-auto no-scrollbar">
                        <!-- 지출 리스트 -->
                    </div>
                </div>

                <!-- 투두 리스트 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="todo-date-title" class="text-lg font-bold text-gray-900">할 일</h2>
                        <button onclick="openTodoModal()" class="p-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="daily-todo-list" class="space-y-2 h-[135px] overflow-y-auto no-scrollbar">
                        <!-- 투두 리스트 -->
                    </div>
                </div>

                <!-- 메모 섹션 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-gray-900">메모</h2>
                    </div>
                    <textarea 
                        id="daily-memo" 
                        oninput="saveMemo(this.value)" 
                        placeholder="기억해야 할 중요한 내용을 기록하세요..." 
                        class="w-full h-32 p-4 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-amber-400 outline-none text-sm resize-none no-scrollbar leading-relaxed"
                    ></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달: 예산 설정 -->
    <div id="budget-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-4">기본 월 예산</h2>
            <input type="number" id="input-budget" placeholder="₩ 0" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none font-mono">
            <div class="flex gap-2">
                <button onclick="closeModal('budget-modal')" class="flex-1 py-3 text-gray-500 font-semibold">취소</button>
                <button onclick="saveBudget()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-semibold">저장</button>
            </div>
        </div>
    </div>

    <!-- 모달: 추가 예산 -->
    <div id="extra-budget-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-2">추가 수입/생활비</h2>
            <p class="text-xs text-gray-400 mb-4">이번 달에만 특별히 추가할 금액을 입력하세요.</p>
            <input type="number" id="input-extra-budget" placeholder="₩ 0" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none font-mono">
            <div class="flex gap-2">
                <button onclick="closeModal('extra-budget-modal')" class="flex-1 py-3 text-gray-500 font-semibold">취소</button>
                <button onclick="saveExtraBudget()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-semibold">추가</button>
            </div>
        </div>
    </div>

    <!-- 모달: 지출 기록 -->
    <div id="expense-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h2 class="text-xl font-bold mb-4">지출 기록 추가</h2>
            <div class="space-y-4">
                <input type="date" id="input-date" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="text" id="input-desc" placeholder="항목명 (예: 치킨, 버스비)" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                <select id="input-category" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="식비">식비</option>
                    <option value="교통">교통</option>
                    <option value="주거">주거/통신</option>
                    <option value="여가">여가/쇼핑</option>
                    <option value="기타">기타</option>
                </select>
                <input type="number" id="input-amount" placeholder="₩ 금액 입력" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono">
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal('expense-modal')" class="flex-1 py-3 text-gray-500 font-semibold">취소</button>
                <button onclick="saveExpense()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-semibold">추가하기</button>
            </div>
        </div>
    </div>

    <!-- 모달: 투두 추가 -->
    <div id="todo-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h2 class="text-xl font-bold mb-4">새로운 할 일</h2>
            <div class="space-y-4">
                <input type="date" id="todo-input-date" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="text" id="todo-input-desc" placeholder="무엇을 해야 하나요?" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                
                <div>
                    <label class="block text-xs font-semibold text-gray-400 mb-2">색상 선택</label>
                    <div id="todo-color-picker" class="flex gap-3 items-center">
                        <div class="color-chip bg-blue-500 active" data-color="blue" onclick="selectTodoColor('blue')"></div>
                        <div class="color-chip bg-emerald-500" data-color="emerald" onclick="selectTodoColor('emerald')"></div>
                        <div class="color-chip bg-amber-500" data-color="amber" onclick="selectTodoColor('amber')"></div>
                        <div class="color-chip bg-purple-500" data-color="purple" onclick="selectTodoColor('purple')"></div>
                        <div class="color-chip bg-rose-500" data-color="rose" onclick="selectTodoColor('rose')"></div>
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-8">
                <button onclick="closeModal('todo-modal')" class="flex-1 py-3 text-gray-500 font-semibold">취소</button>
                <button onclick="saveTodo()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-semibold">등록하기</button>
            </div>
        </div>
    </div>

    <script>
        let state = {
            budget: 0,
            monthlyExtras: {},
            expenses: [],
            todos: [],
            memos: {}, 
            currentDate: new Date(),
            selectedDate: new Date().toISOString().split('T')[0],
            selectedTodoColor: 'blue'
        };

        function init() {
            const saved = localStorage.getItem('budget_todo_v5');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                state.currentDate = new Date(state.currentDate);
            }

            const inputs = [
                { id: 'input-budget', fn: saveBudget },
                { id: 'input-extra-budget', fn: saveExtraBudget },
                { id: 'input-amount', fn: saveExpense },
                { id: 'todo-input-desc', fn: saveTodo }
            ];

            inputs.forEach(item => {
                const el = document.getElementById(item.id);
                if (el) {
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') item.fn();
                    });
                }
            });

            updateUI();
        }

        function saveData() {
            localStorage.setItem('budget_todo_v5', JSON.stringify(state));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount).replace('₩', '₩ ');
        }

        function getMonthKey() {
            const y = state.currentDate.getFullYear();
            const m = String(state.currentDate.getMonth() + 1).padStart(2, '0');
            return `${y}-${m}`;
        }

        function updateUI() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const monthKey = getMonthKey();
            
            const monthExpenses = state.expenses.filter(e => e.date.startsWith(monthKey));
            const totalSpent = monthExpenses.reduce((s, e) => s + e.amount, 0);
            const extra = state.monthlyExtras[monthKey] || 0;
            const totalBudget = state.budget + extra;

            document.getElementById('budget-label').textContent = `${month + 1}월 목표 예산`;
            document.getElementById('display-budget').textContent = formatCurrency(totalBudget);
            document.getElementById('display-spent').textContent = formatCurrency(totalSpent);
            document.getElementById('display-remaining').textContent = formatCurrency(totalBudget - totalSpent);

            const badge = document.getElementById('extra-budget-badge');
            if (extra > 0) {
                badge.textContent = `+ 추가 생활비 ${formatCurrency(extra)} 포함`;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            renderCalendar(year, month);
            renderDailyDetails();
            lucide.createIcons();
        }

        function selectTodoColor(color) {
            state.selectedTodoColor = color;
            const chips = document.querySelectorAll('.color-chip');
            chips.forEach(chip => {
                if (chip.dataset.color === color) chip.classList.add('active');
                else chip.classList.remove('active');
            });
        }

        function renderCalendar(year, month) {
            const body = document.getElementById('calendar-body');
            document.getElementById('calendar-title').textContent = `${year}년 ${month + 1}월`;
            body.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            const colorMap = {
                blue: 'text-blue-500',
                emerald: 'text-emerald-500',
                amber: 'text-amber-500',
                purple: 'text-purple-500',
                rose: 'text-rose-500'
            };

            for (let i = 0; i < firstDay; i++) {
                body.innerHTML += `<div class="calendar-day pointer-events-none"></div>`;
            }

            for (let date = 1; date <= lastDate; date++) {
                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const isSelected = state.selectedDate === dayStr;
                const isToday = todayStr === dayStr;
                
                const daySpent = state.expenses.filter(e => e.date === dayStr).reduce((s, e) => s + e.amount, 0);
                const dayTodos = state.todos.filter(t => t.date === dayStr);
                
                const maxDisplayTodos = 5; 
                const visibleTodos = dayTodos.slice(0, maxDisplayTodos);
                const extraTodosCount = dayTodos.length - maxDisplayTodos;

                const div = document.createElement('div');
                div.className = `calendar-day ${isSelected ? 'selected' : ''} ${isToday ? 'today' : ''}`;
                div.onclick = () => {
                    state.selectedDate = dayStr;
                    updateUI();
                };

                const todoHtml = visibleTodos.map(t => `
                    <div class="calendar-todo-text ${t.completed ? 'text-gray-300 line-through' : (colorMap[t.color] || 'text-blue-500') + ' font-medium'}">
                        • ${t.desc}
                    </div>
                `).join('');

                div.innerHTML = `
                    <div class="text-xs font-bold mb-0.5 ${isToday ? 'text-green-600' : 'text-gray-400'}">${date}</div>
                    <div class="overflow-hidden flex-grow">
                        ${todoHtml}
                    </div>
                    <div class="flex justify-between items-end mt-0.5 pt-0.5 border-t border-gray-50">
                        <div class="text-[9px] font-bold text-gray-400 leading-none">
                            ${extraTodosCount > 0 ? `+${extraTodosCount}` : ''}
                        </div>
                        <div class="text-[10px] font-bold text-red-500 leading-none">
                            ${daySpent > 0 ? `-${daySpent}` : ''}
                        </div>
                    </div>
                `;
                body.appendChild(div);
            }

            const totalCellsSoFar = firstDay + lastDate;
            const remainingCells = (totalCellsSoFar % 7 === 0) ? 0 : 7 - (totalCellsSoFar % 7);
            for (let i = 0; i < remainingCells; i++) {
                body.innerHTML += `<div class="calendar-day pointer-events-none"></div>`;
            }
        }

        function renderDailyDetails() {
            const [y, m, d] = state.selectedDate.split('-');
            const dateLabel = `${parseInt(m)}월 ${parseInt(d)}일`;
            
            document.getElementById('selected-date-title').textContent = `${dateLabel} 지출`;
            document.getElementById('todo-date-title').textContent = `${dateLabel} 할 일`;

            document.getElementById('daily-memo').value = state.memos[state.selectedDate] || '';

            const dailyEx = state.expenses.filter(e => e.date === state.selectedDate);
            const exList = document.getElementById('daily-expense-list');
            if (dailyEx.length === 0) {
                exList.innerHTML = '<p class="text-center text-gray-300 py-8 text-sm">지출 내역이 없습니다.</p>';
            } else {
                exList.innerHTML = dailyEx.map(ex => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl group shrink-0">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center shadow-sm shrink-0">
                                <i data-lucide="${getIcon(ex.category)}" class="w-4 h-4 text-gray-400"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700 truncate">${ex.desc}</span>
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <span class="text-sm font-bold text-red-500">-${formatCurrency(ex.amount).replace('₩ ', '')}</span>
                            <button onclick="event.stopPropagation(); deleteItem('expenses', '${ex.id}')" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-400 transition">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            const dailyTodos = state.todos
                .filter(t => t.date === state.selectedDate)
                .sort((a, b) => a.completed - b.completed);

            const todoList = document.getElementById('daily-todo-list');
            
            const colorBgMap = {
                blue: 'bg-blue-500 border-blue-500',
                emerald: 'bg-emerald-500 border-emerald-500',
                amber: 'bg-amber-500 border-amber-500',
                purple: 'bg-purple-500 border-purple-500',
                rose: 'bg-rose-500 border-rose-500'
            };

            if (dailyTodos.length === 0) {
                todoList.innerHTML = '<p class="text-center text-gray-300 py-8 text-sm">할 일이 없습니다.</p>';
            } else {
                todoList.innerHTML = dailyTodos.map(t => `
                    <div class="flex items-center justify-between p-3 border border-gray-100 rounded-xl group shrink-0 ${t.completed ? 'bg-gray-50' : 'bg-white shadow-sm'}">
                        <div class="flex items-center gap-3 cursor-pointer flex-1 overflow-hidden" onclick="toggleTodo('${t.id}')">
                            <div class="w-5 h-5 rounded-md border-2 flex items-center justify-center transition shrink-0 ${t.completed ? colorBgMap[t.color] : 'border-gray-200'}">
                                ${t.completed ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                            </div>
                            <span class="text-sm font-medium todo-item truncate ${t.completed ? 'completed text-gray-400' : 'text-gray-700'}">${t.desc}</span>
                        </div>
                        <button onclick="event.stopPropagation(); deleteItem('todos', '${t.id}')" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-400 transition ml-2 shrink-0">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function getIcon(cat) {
            const icons = { '식비': 'utensils', '교통': 'bus', '주거': 'home', '여가': 'shopping-bag' };
            return icons[cat] || 'more-horizontal';
        }

        function openBudgetModal() { 
            document.getElementById('input-budget').value = state.budget || '';
            showModal('budget-modal'); 
            setTimeout(() => document.getElementById('input-budget').focus(), 100);
        }
        function openExtraBudgetModal() { 
            document.getElementById('input-extra-budget').value = state.monthlyExtras[getMonthKey()] || '';
            showModal('extra-budget-modal'); 
            setTimeout(() => document.getElementById('input-extra-budget').focus(), 100);
        }
        function openExpenseModal() { 
            document.getElementById('input-date').value = state.selectedDate;
            showModal('expense-modal'); 
            setTimeout(() => document.getElementById('input-desc').focus(), 100);
        }
        function openTodoModal() { 
            document.getElementById('todo-input-date').value = state.selectedDate;
            selectTodoColor('blue'); 
            showModal('todo-modal'); 
            setTimeout(() => document.getElementById('todo-input-desc').focus(), 100);
        }

        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function saveBudget() {
            state.budget = parseInt(document.getElementById('input-budget').value) || 0;
            saveData(); updateUI(); closeModal('budget-modal');
        }

        function saveExtraBudget() {
            const val = parseInt(document.getElementById('input-extra-budget').value) || 0;
            const key = getMonthKey();
            if (val === 0) delete state.monthlyExtras[key];
            else state.monthlyExtras[key] = val;
            saveData(); updateUI(); closeModal('extra-budget-modal');
        }

        function saveExpense() {
            const date = document.getElementById('input-date').value;
            const desc = document.getElementById('input-desc').value;
            const category = document.getElementById('input-category').value;
            const amount = parseInt(document.getElementById('input-amount').value);
            if (!desc || isNaN(amount)) return;
            state.expenses.push({ id: Date.now().toString(), date, desc, category, amount });
            saveData(); updateUI(); closeModal('expense-modal');
            document.getElementById('input-desc').value = '';
            document.getElementById('input-amount').value = '';
        }

        function saveTodo() {
            const date = document.getElementById('todo-input-date').value;
            const desc = document.getElementById('todo-input-desc').value;
            if (!desc) return;
            state.todos.push({ 
                id: Date.now().toString(), 
                date, 
                desc, 
                completed: false,
                color: state.selectedTodoColor 
            });
            saveData(); updateUI(); closeModal('todo-modal');
            document.getElementById('todo-input-desc').value = '';
        }

        function saveMemo(text) {
            if (text.trim() === "") {
                delete state.memos[state.selectedDate];
            } else {
                state.memos[state.selectedDate] = text;
            }
            saveData();
        }

        function toggleTodo(id) {
            const todo = state.todos.find(t => t.id === id);
            if (todo) todo.completed = !todo.completed;
            saveData(); updateUI();
        }

        function deleteItem(type, id) {
            state[type] = state[type].filter(item => item.id !== id);
            saveData(); updateUI();
        }

        function changeMonth(offset) {
            state.currentDate.setMonth(state.currentDate.getMonth() + offset);
            updateUI();
        }

        window.onload = init;
    </script>
</body>
</html>
